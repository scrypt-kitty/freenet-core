<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Contracts - Freenet Manual</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Components</li><li class="chapter-item expanded "><a href="../components/overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../components/contracts.html" class="active"><strong aria-hidden="true">3.</strong> Contracts</a></li><li class="chapter-item expanded "><a href="../components/delegates.html"><strong aria-hidden="true">4.</strong> Delegates</a></li><li class="chapter-item expanded "><a href="../components/ui.html"><strong aria-hidden="true">5.</strong> User Interfaces</a></li><li class="chapter-item expanded affix "><li class="part-title">Architecture</li><li class="chapter-item expanded "><a href="../architecture/p2p-network.html"><strong aria-hidden="true">6.</strong> P2P Network</a></li><li class="chapter-item expanded "><a href="../architecture/irouting.html"><strong aria-hidden="true">7.</strong> Intelligent Routing</a></li><li class="chapter-item expanded "><a href="../architecture/transport.html"><strong aria-hidden="true">8.</strong> Transport</a></li><li class="chapter-item expanded affix "><li class="part-title">Developer Guide</li><li class="chapter-item expanded "><a href="../tutorial.html"><strong aria-hidden="true">9.</strong> Tutorial: Create an App</a></li><li class="chapter-item expanded "><a href="../contract-interface.html"><strong aria-hidden="true">10.</strong> Contract interfaces</a></li><li class="chapter-item expanded "><a href="../manifest.html"><strong aria-hidden="true">11.</strong> freenet.toml format</a></li><li class="chapter-item expanded affix "><li class="part-title">Examples</li><li class="chapter-item expanded "><a href="../examples/antiflood-tokens.html"><strong aria-hidden="true">12.</strong> Antiflood Tokens</a></li><li class="chapter-item expanded "><a href="../examples/blind-trust-tokens.html"><strong aria-hidden="true">13.</strong> Blind Trust Tokens</a></li><li class="chapter-item expanded affix "><li class="part-title">Community and Support</li><li class="chapter-item expanded "><a href="../community.html"><strong aria-hidden="true">14.</strong> Community</a></li><li class="chapter-item expanded affix "><li class="part-title">Reference</li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">15.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Freenet Manual</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="contracts"><a class="header" href="#contracts">Contracts</a></h2>
<p>Freenet is essentially a global decentralized key-value store where keys are
WebAssembly code called Contracts. Contracts are stored in the network,
along with their data or "state". The contract controls what state is permitted
and how it can be modified, and also how to efficiently synchronize state
between peers.</p>
<p>A contract's state is just a block of bytes, and can be anything from a simple
number to a complex data structure. The contract's code defines the state's
formatting. Even the serialization format is up to the contract, so it can be
anything from JSON to Bincode, or a custom binary format.</p>
<p>Network users can read a contract's state and subscribe to receive immediate
updates if the state is modified.</p>
<p>Contracts play a similar role in Freenet to databases and real-time
publish-subscribe mechanisms in traditional online services, while being
entirely decentralized, secure, and scalable.</p>
<ul>
<li><a href="#contract-operation">Contract Operation</a>
<ul>
<li><a href="#state-synchronization-and-merging">State synchronization and merging</a>
<ul>
<li><a href="#fundamental-concepts">Fundamental Concepts</a></li>
<li><a href="#efficient-state-synchronization">Efficient State Synchronization</a></li>
</ul>
</li>
<li><a href="#blog-use-case">Blog Use Case</a></li>
<li><a href="#writing-a-contract-in-rust">Writing a Contract in Rust</a>
<ul>
<li><a href="#the-contractinterface-trait">The <code>ContractInterface</code> Trait</a></li>
<li><a href="#flexibility-versus-convenience">Flexibility versus Convenience</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="contract-operation"><a class="header" href="#contract-operation">Contract Operation</a></h2>
<h3 id="state-synchronization-and-merging"><a class="header" href="#state-synchronization-and-merging">State synchronization and merging</a></h3>
<h4 id="fundamental-concepts"><a class="header" href="#fundamental-concepts">Fundamental Concepts</a></h4>
<p>Contracts need to provide a mechanism to merge any two valid states, creating a
new state that integrates both. This process ensures the eventual consistency of
contract states in Freenet, a concept similar to <a href="https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type">Conflict-free Replicated Data
Types</a>.</p>
<p>As a very simple example, if the contract's state is a single number, then the
contract could define the merging of two states as the maximum of the two numbers.</p>
<p>In mathematical terms, a contract defines a <a href="https://mathworld.wolfram.com/CommutativeMonoid.html">commutative
monoid</a> on the contract's
state - but you can ignore this if you're not a mathematician.</p>
<h4 id="efficient-state-synchronization"><a class="header" href="#efficient-state-synchronization">Efficient State Synchronization</a></h4>
<p>Naively we could transfer the entire state between peers, but this would be
inefficient for larger states. Instead, Freenet transmits only the
difference between states.</p>
<p>To do this a contract implements three functions:</p>
<ul>
<li>
<p><code>summarize_state</code> - Returns a concise summary of the contract's
state.</p>
</li>
<li>
<p><code>get_state_delta</code> - Compares the contract's state against the summary of
another state and returns the difference between the two, the "delta".</p>
</li>
<li>
<p><code>update_state</code> - Applies a delta to the contract's state, updating it to
bring it in sync with the other peer's contract state.</p>
</li>
</ul>
<p>Contracts can implement these functions however they wish depending on the
type of data their state contains.</p>
<h5 id="step-by-step"><a class="header" href="#step-by-step">Step-by-step</a></h5>
<p>PeerA and PeerB need to synchronize their states. The algorithm for efficient
state synchronization consists of the following steps:</p>
<ol>
<li>
<p><strong>Summarize State by Initiator</strong>: PeerA compiles a concise summary of its
current state using the <code>summarize_state</code> function.</p>
<ul>
<li>This summary is transmitted to PeerB</li>
</ul>
</li>
<li>
<p><strong>Compare State at Receiver</strong>: PeerB uses <code>get_state_delta</code> to compare the
summary against its own state.</p>
<ul>
<li>If they are different, proceed to the next step; if not, synchronization is
complete.</li>
</ul>
</li>
<li>
<p><strong>Send Delta</strong>: If the states are different, PeerB calculates the delta and
sends it to PeerA.</p>
</li>
<li>
<p><strong>Apply Delta</strong>: PeerA applies this received delta to its state using
<code>update_state</code>.</p>
</li>
<li>
<p><strong>Reverse Synchronization</strong>: This process is repeated in the opposite direction.</p>
</li>
</ol>
<p>This approach allows peers to synchronize state over the network while minimizing
data transfer.</p>
<h3 id="blog-use-case"><a class="header" href="#blog-use-case">Blog Use Case</a></h3>
<p>Consider a public blog contract. The state of this contract would be the blog's
content, including blog posts. The contract's code requires that new
posts can only be added if they are signed by the blog's owner. The owner's
public key is part of the contract's parameters.</p>
<p>The contract would summarize its state by returning a list of post identifiers,
and the state delta would be a list of new posts. The contract would apply the
delta by appending the new posts to its list of posts. The contract may have
a limit on the number of posts it can store, in which case it would remove old
posts to make room for new ones.</p>
<h3 id="writing-a-contract-in-rust"><a class="header" href="#writing-a-contract-in-rust">Writing a Contract in Rust</a></h3>
<p>Freenet Contracts can be written in any programming language that compiles to
WebAssembly, but as Freenet is written in Rust it is currently the best supported
language for writing contracts.</p>
<h4 id="the-contractinterface-trait"><a class="header" href="#the-contractinterface-trait">The <code>ContractInterface</code> Trait</a></h4>
<p>Rust contracts implement the <code>ContractInterface</code> trait, which defines the
functions that the core calls to interact with the contract. This trait is
defined in the
<a href="https://github.com/freenet/freenet-stdlib/blob/f28e6716364b4e1c9ae8837344286393a2da4c82/rust/src/contract_interface.rs#L446">freenet-stdlib</a>.</p>
<pre><code class="language-rust no_run noplayground">/// # ContractInterface
///
/// This trait defines the core functionality for managing and updating a contract's state.
/// Implementations must ensure that state delta updates are *commutative*. In other words,
/// when applying multiple delta updates to a state, the order in which these updates are
/// applied should not affect the final state. Once all deltas are applied, the resulting
/// state should be the same, regardless of the order in which the deltas were applied.
///
/// Noncompliant behavior, such as failing to obey the commutativity rule, may result
/// in the contract being deprioritized or removed from the p2p network.
pub trait ContractInterface {
    /// Verify that the state is valid, given the parameters.
    fn validate_state(
        parameters: Parameters&lt;'static&gt;,
        state: State&lt;'static&gt;,
        related: RelatedContracts&lt;'static&gt;,
    ) -&gt; Result&lt;ValidateResult, ContractError&gt;;

    /// Update the state to account for the new data
    fn update_state(
        parameters: Parameters&lt;'static&gt;,
        state: State&lt;'static&gt;,
        data: Vec&lt;UpdateData&lt;'static&gt;&gt;,
    ) -&gt; Result&lt;UpdateModification&lt;'static&gt;, ContractError&gt;;

    /// Generate a concise summary of a state that can be used to create deltas
    /// relative to this state.
    fn summarize_state(
        parameters: Parameters&lt;'static&gt;,
        state: State&lt;'static&gt;,
    ) -&gt; Result&lt;StateSummary&lt;'static&gt;, ContractError&gt;;

    /// Generate a state delta using a summary from the current state.
    /// This along with [`Self::summarize_state`] allows flexible and efficient
    /// state synchronization between peers.
    fn get_state_delta(
        parameters: Parameters&lt;'static&gt;,
        state: State&lt;'static&gt;,
        summary: StateSummary&lt;'static&gt;,
    ) -&gt; Result&lt;StateDelta&lt;'static&gt;, ContractError&gt;;
}</code></pre>
<h4 id="flexibility-versus-convenience"><a class="header" href="#flexibility-versus-convenience">Flexibility versus Convenience</a></h4>
<p>The <code>ContractInterface</code> trait is a low-level "Layer 0" API that provides direct
access to the contract's state and parameters. This API is useful for contracts
that require fine-grained control over their state, but can be cumbersome.</p>
<p>Soon we will provide higher-level APIs on top of Layer 0 that will sacrifice
some flexibility for ease of contract implementation.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../components/overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../components/delegates.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../components/overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../components/delegates.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>


    </div>
    </body>
</html>
